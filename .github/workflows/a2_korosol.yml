name: üöÄ Deploy to A2 Hosting

on:
  push:
    branches: [dev/pipelineTry]
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'
  SSH_HOST: ${{ secrets.SSH_HOST }}
  SSH_USER: ${{ secrets.SSH_USER }}
  SSH_PORT: ${{ secrets.SSH_PORT }}
  SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
  # Use the EXACT path from your A2 account - check with 'pwd' when you SSH in
  DEPLOY_PATH: 'PROD_THINGS/dotnet/kobflow/github_actions_delivery'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: üì¶ Checkout code
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: üîÑ Restore and Build
      run: |
        dotnet restore
        dotnet build --configuration Release --no-restore

    - name: üì§ Publish projects
      run: |
        dotnet publish ./Kuaminika.KobFlow.API.Expense/Kuaminika.KobFlow.API.Expense.csproj -c Release -o publish/ --nologo

    - name: üîë Install SSHpass
      run: sudo apt-get install -y sshpass

    - name: üõ†Ô∏è Prepare Deployment Directory on A2
      run: |
        echo "Preparing deployment directory on A2..."
        # First, ensure the base directory exists and has right permissions
        sshpass -p "${{ env.SSH_PASSWORD }}" ssh -p ${{ env.SSH_PORT }} -o StrictHostKeyChecking=no \
          ${{ env.SSH_USER }}@${{ env.SSH_HOST }} \
          "mkdir -p ${{ env.DEPLOY_PATH }} && chmod 755 ${{ env.DEPLOY_PATH}}"

    - name: üöÄ Deploy using SCP (better for A2)
      run: |
        echo "Deploying files to A2..."
        # Deploy files one by one or in batches
        sshpass -p "${{ env.SSH_PASSWORD }}" scp -P ${{ env.SSH_PORT }} -o StrictHostKeyChecking=no -r \
          publish/* ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:${{ env.DEPLOY_PATH }}/

    - name: üîí Set correct permissions
      run: |
        echo "Setting file permissions on A2..."
        sshpass -p "${{ env.SSH_PASSWORD }}" ssh -p ${{ env.SSH_PORT }} -o StrictHostKeyChecking=no \
          ${{ env.SSH_USER }}@${{ env.SSH_HOST }} \
          "chmod 755 -R ${{ env.DEPLOY_PATH }} && find ${{ env.DEPLOY_PATH }} -type f -exec chmod 644 {} \;"

    - name: ‚úÖ Verify deployment
      run: |
        sshpass -p "${{ env.SSH_PASSWORD }}" ssh -p ${{ env.SSH_PORT }} -o StrictHostKeyChecking=no \
          ${{ env.SSH_USER }}@${{ env.SSH_HOST }} \
          "ls -la ${{ env.DEPLOY_PATH }} && echo 'üéâ Deployment successful!'"
