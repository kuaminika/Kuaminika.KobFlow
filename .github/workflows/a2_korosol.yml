name: üöÄ Deploy to A2 Hosting

on:
  push:
    branches: [dev/pipelineTry]
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'
  SSH_HOST: ${{ secrets.SSH_HOST }}
  SSH_USER: ${{ secrets.SSH_USER }}
  SSH_PORT: ${{ secrets.SSH_PORT }}  # A2 usually uses port 7822 for SSH!
  DEPLOY_PATH: '~/PROD_THINGS/dotnet/kobflow/github_actions_delivery'
  SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}  # Often needed for A2

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: üì¶ Checkout code
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: üîÑ Restore and Build
      run: |
        dotnet restore
        dotnet build --configuration Release --no-restore

    - name: üì§ Publish projects
      run: |
        # Publish your specific projects
        dotnet publish ./Kuaminika.KobFlow.API.Expense/Kuaminika.KobFlow.API.Expense.csproj -c Release -o publish/ --nologo

    - name: üîë Install SSHpass for password authentication
      run: sudo apt-get install -y sshpass

    - name: üß™ Test SSH connection (with password)
      run: |
        echo "Testing connection to ${{ env.SSH_HOST }}:${{ env.SSH_PORT }}..."
        sshpass -p "${{ env.SSH_PASSWORD }}" ssh -p ${{ env.SSH_PORT }} -o StrictHostKeyChecking=no \
          ${{ env.SSH_USER }}@${{ env.SSH_HOST }} \
          "echo '‚úÖ SSH connection successful!'; pwd"

    - name: üöÄ Deploy using SCP (more reliable than rsync for A2)
      run: |
        echo "Uploading files to A2 hosting..."
        
        # Create deploy directory first
        sshpass -p "${{ env.SSH_PASSWORD }}" ssh -p ${{ env.SSH_PORT }} -o StrictHostKeyChecking=no \
          ${{ env.SSH_USER }}@${{ env.SSH_HOST }} \
          "mkdir -p ${{ env.DEPLOY_PATH }}"
        
        # Upload files using SCP
        sshpass -p "${{ env.SSH_PASSWORD }}" scp -P ${{ env.SSH_PORT }} -o StrictHostKeyChecking=no -r \
          publish/* ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:${{ env.DEPLOY_PATH }}/

    - name: ‚úÖ Set permissions on A2 server
      run: |
        echo "Setting file permissions..."
        sshpass -p "${{ env.SSH_PASSWORD }}" ssh -p ${{ env.SSH_PORT }} -o StrictHostKeyChecking=no \
          ${{ env.SSH_USER }}@${{ env.SSH_HOST }} \
          "chmod 755 -R ${{ env.DEPLOY_PATH }} && find ${{ env.DEPLOY_PATH }} -type f -exec chmod 644 {} \;"

    - name: üìã Verify deployment
      run: |
        sshpass -p "${{ env.SSH_PASSWORD }}" ssh -p ${{ env.SSH_PORT }} -o StrictHostKeyChecking=no \
          ${{ env.SSH_USER }}@${{ env.SSH_HOST }} \
          "ls -la ${{ env.DEPLOY_PATH }} && echo 'üéâ Deployment successful!'"
